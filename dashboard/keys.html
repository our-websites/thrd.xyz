<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Thrd Dashboard</title>
<link rel="icon" type="image/x-icon" href="https://thrd.xyz/favicon.ico">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.tailwindcss.com" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous">

<style>
* {margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
body {background:#1a1a1a;color:#fff;overflow-x:hidden;display:flex;min-height:100vh;}
a {text-decoration:none;color:inherit;}

.sidebar {width:280px;background:#111;display:flex;flex-direction:column;gap:2rem;padding:2rem 1rem;transition:width 0.3s;flex-shrink:0;position:relative;}
.sidebar.collapsed {width:80px;}
.sidebar .logo {display:flex;align-items:center;gap:0.5rem;margin-bottom:2rem;transition:all 0.3s;}
.sidebar .logo img {width:32px;height:32px;}
.sidebar.collapsed .logo span {display:none;}
.sidebar .user-info {text-align:center;transition:all 0.3s;opacity:1;}
.sidebar.collapsed .user-info {opacity:0;height:0;overflow:hidden;pointer-events:none;}
.sidebar .user-info img {width:64px;height:64px;border-radius:9999px;margin:0 auto 0.5rem auto;}
.sidebar-btn {display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;border-radius:0.75rem;cursor:pointer;color:#fff;white-space:nowrap;transition:background 0.2s,color 0.2s;}
.sidebar-btn:hover, .sidebar-btn.active {background:linear-gradient(90deg,#ff7518,#ffb347);color:#1a1a1a;}
.sidebar-btn i {width:24px;text-align:center;}
.sidebar.collapsed .sidebar-btn span {display:none;}

.main {flex:1;padding:2rem;display:flex;flex-direction:column;gap:2rem;overflow-x:hidden;}
.main h1 {font-size:2.5rem;font-weight:bold;background:linear-gradient(90deg,#ffb347,#ff7518);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

.bot-frame {
  background:#222;border-left:4px solid #ff7518;border-radius:12px;padding:2rem;color:#fff;display:flex;flex-direction:column;gap:1rem;width:100%;max-width:none;
}
.bot-frame h3 {font-size:1.5rem;font-weight:bold;color:#ffb347;margin-bottom:1rem;}
.credential-label {font-weight:500; margin-bottom:0.25rem;}
.copyable {background:#111;border:1px solid #ff7518;border-radius:8px;padding:0.75rem;font-family:monospace;cursor:pointer;transition:all 0.2s;width:100%;}
.copyable:hover {background:#ff7518;color:#1a1a1a;}

.loading-overlay {position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:50;}
.spinner {border:4px solid rgba(255,255,255,0.2);border-top:4px solid #ff7518;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;}
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

.toggle-btn {position:absolute;top:1rem;right:-1rem;background:#111;border:2px solid #ff7518;color:#ff7518;border-radius:9999px;width:2rem;height:2rem;display:flex;justify-content:center;align-items:center;cursor:pointer;z-index:10;transition:all 0.3s;}
.toggle-btn:hover {background:#ff7518;color:#1a1a1a;}

#toast {
  position: fixed;
  bottom: -60px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #ff7518;
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: 500;
  opacity: 0;
  transition: all 0.3s ease-in-out;
  z-index: 100;
}
#toast.show { bottom: 20px; opacity: 1; }

#createPanelBtn {
  background: linear-gradient(90deg,#ffb347,#ff7518);
  color: #1a1a1a;
  font-weight: 600;
  padding: 0.75rem 1.5rem;
  border-radius: 0.75rem;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
  width: fit-content;
}
#createPanelBtn:hover {
  background: linear-gradient(90deg,#ff7518,#ffb347);
}
</style>
</head>
<body class="flex relative">

<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
</div>

<div id="sidebar" class="sidebar relative">
  <div class="toggle-btn" id="toggleSidebar"><i class="fas fa-angle-left"></i></div>

  <div class="logo">
    <img src="https://thrd.xyz/logo.png" alt="Logo" class="w-8 h-8">
    <span class="text-xl font-bold text-orange-400">Thrd</span>
  </div>

  <div class="user-info">
    <img id="userAvatar" src="https://cdn.discordapp.com/embed/avatars/0.png" alt="Avatar">
    <h2 id="userName">Loading...</h2>
    <p id="userEmail"></p>
  </div>

  <div class="flex flex-col gap-2 mt-4">
    <a href="https://thrd.xyz/dashboard" class="sidebar-btn">
      <i class="fas fa-home"></i><span>Dashboard</span>
    </a>
    <a href="https://thrd.xyz/dashboard/bots" class="sidebar-btn">
      <i class="fas fa-robot"></i><span>Bots</span>
    </a>
    <a href="https://thrd.xyz/dashboard/keys" class="sidebar-btn active">
      <i class="fas fa-key"></i><span>Keys</span>
    </a>
  </div>
</div>

<div class="main">
  <h2 class="text-2xl font-bold mb-4">Manage your login keys</h2>

  <div id="botFrame" class="bot-frame" style="display:none;">
    <h3>Credentials</h3>
    <div class="flex flex-col gap-4">
      <div>
        <p class="credential-label">Username:</p>
        <p class="copyable" id="username" title="Click to copy">Loading username...</p>
      </div>
      <div>
        <p class="credential-label">Password:</p>
        <p class="copyable" id="password" title="Click to copy">Loading password...</p>
      </div>
      <p class="text-sm text-gray-400 mt-2">
        Use these credentials to access <a href="https://panel.thrd.xyz" target="_blank" class="text-blue-500 hover:underline">Puffer Panel</a>
      </p>
    </div>
  </div>

  <div id="createPanelContainer" style="display:none;">
    <button id="createPanelBtn">Create Panel Account</button>
  </div>
</div>

<div id="toast">Copied to clipboard!</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const { url: SUPABASE_URL, key: SUPABASE_KEY } = await fetch('https://thrd.xyz/supabase.json')
  .then(res => res.json())
  .catch(() => ({ url: '', key: '' }));

if (!SUPABASE_URL || !SUPABASE_KEY) window.location.href = "https://thrd.xyz/";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

(async function() {
  const overlay = document.getElementById('loadingOverlay');
  const botFrame = document.getElementById('botFrame');
  const createPanelContainer = document.getElementById('createPanelContainer');
  const createPanelBtn = document.getElementById('createPanelBtn');

  const hash = new URLSearchParams(window.location.hash.slice(1));
  const accessToken = hash.get('access_token');
  const refreshToken = hash.get('refresh_token');

  if (accessToken) {
    const { error } = await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
    if (error) return (window.location.href = "/");
    window.history.replaceState(null, "", window.location.pathname);
  }

  const { data:{ session } } = await supabase.auth.getSession();
  if (!session) return (window.location.href = "/");
  const { data:{ user } } = await supabase.auth.getUser();
  if (!user) return (window.location.href = "/");

  document.getElementById('userAvatar').src = user.user_metadata?.avatar_url || "https://cdn.discordapp.com/embed/avatars/0.png";
  document.getElementById('userName').textContent = user.user_metadata?.full_name || user.email;
  document.getElementById('userEmail').textContent = user.email;

  const userId = user.id;

  const { data: credentials, error } = await supabase
    .from('credentials')
    .select('username,password,created_account')
    .eq('user_id', userId)
    .single();

  overlay.style.display = 'none';

  if (error || !credentials) {
    showToast("Failed to load credentials");
    return;
  }

  if (credentials.created_account) {
    botFrame.style.display = 'flex';
    const usernameEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');

    usernameEl.textContent = credentials.username + "#login@thrd.xyz";
    passwordEl.textContent = credentials.password;

    usernameEl.onclick = async () => {
      await navigator.clipboard.writeText(credentials.username + "#login@thrd.xyz");
      showToast("Username copied!");
    };
    passwordEl.onclick = async () => {
      await navigator.clipboard.writeText(credentials.password);
      showToast("Password copied!");
    };
  } else {
    createPanelContainer.style.display = 'block';
  }

createPanelBtn.onclick = async () => {
    createPanelBtn.disabled = true;
    createPanelBtn.textContent = "Creating...";
    try {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");
        myHeaders.append("Authorization", `Bearer ${SUPABASE_KEY}`);
        const raw = JSON.stringify({
            user_id: userId
        });
        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw
        };
        const res = await fetch(${SUPABASE_URL}/functions/v1 / create - panel - user, requestOptions);
        if (!res.ok) throw new Error("Failed to create panel user");
        showToast("Panel account created!");
        createPanelContainer.style.display = 'none';
        botFrame.style.display = 'flex';
        location.reload();
    } catch (err) {
        console.error(err);
        showToast("Error creating account");
        createPanelBtn.disabled = false;
        createPanelBtn.textContent = "Create Panel Account";
    }
};
})();

const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggleSidebar');
toggleBtn.onclick = () => {
  sidebar.classList.toggle('collapsed');
  toggleBtn.firstElementChild.classList.toggle('fa-angle-left');
  toggleBtn.firstElementChild.classList.toggle('fa-angle-right');
};
</script>

</body>
</html>
